<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Imagen 4 (Gemini API) — One-file Web Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#121318; --ink:#e9f0f5; --muted:#9fb0bd; --accent:#5cc8ff; }
    * { box-sizing: border-box; }
    html, body { height: 100%; background: linear-gradient(180deg,#0b0c10,#0e1117); color: var(--ink); font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1{ font-size: 20px; margin: 0 0 14px; letter-spacing:.2px}
    .wrap{ max-width: 1100px; margin: 28px auto; padding: 0 16px;}
    .grid{ display: grid; grid-template-columns: 1.1fr .9fr; gap: 16px; }
    .card{ background: var(--card); border: 1px solid #1c2333; border-radius: 14px; padding: 14px 14px 12px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    label{ display: block; font-weight: 600; margin: 8px 0 6px; color: var(--muted); }
    input[type="password"], input[type="text"], textarea, select{
      width: 100%; background: #0f1420; color: var(--ink); border: 1px solid #263043;
      border-radius: 10px; padding: 10px 12px; outline: none;
    }
    textarea{ min-height: 180px; resize: vertical; }
    .row{ display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .row .col-2{ grid-column: span 2; }
    .hint{font-size:12px;color:var(--muted); margin-top:6px}
    button{
      appearance: none; border: 0; background: linear-gradient(180deg,#2aa8ff,#0076ff);
      color: white; padding: 10px 14px; border-radius: 10px; font-weight: 700; cursor: pointer;
      box-shadow: 0 10px 20px rgba(0,118,255,.25);
    }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    .bar{ display:flex; gap:8px; align-items:center; justify-content: space-between; margin-top: 12px;}
    .small{ font-size: 12px; color: var(--muted); }
    .out{ display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 14px; }
    .thumb{ background: #0f1420; border: 1px solid #21304a; border-radius: 12px; padding: 10px; }
    .thumb img{ width: 100%; height: auto; display:block; border-radius: 8px; }
    .actions{ display:flex; gap:8px; margin-top: 8px;}
    .ghost{ background:#1a2538; color:#e8f1ff; }
    .badge{ padding: 4px 8px; border-radius: 999px; font-size: 11px; background:#112136; color:#9ac7ff; border:1px solid #233854 }
    .footer{ margin-top:16px; color:var(--muted); font-size:12px }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Generate Images with <span class="badge">Imagen 4 (Gemini API)</span></h1>
    <div class="grid">
      <form id="form" class="card">
        <label for="key">GEMINI_API_KEY</label>
        <input id="key" name="key" type="password" placeholder="paste your API key here" required />

        <label for="prompt">Prompt</label>
        <textarea id="prompt" name="prompt"></textarea>
        <div class="hint">Prompt đã được prefill từ ví dụ Java của bạn. Bạn có thể chỉnh sửa thoải mái.</div>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="count">sampleCount (1–4)</label>
            <select id="count" name="count">
              <option>1</option><option>2</option><option>3</option><option>4</option>
            </select>
          </div>
          <div>
            <label for="aspect">aspectRatio</label>
            <select id="aspect" name="aspect">
              <option>1:1</option>
              <option>3:4</option>
              <option>4:3</option>
              <option>9:16</option>
              <option selected>16:9</option>
            </select>
          </div>
          <div>
            <label for="size">sampleImageSize</label>
            <select id="size" name="size">
              <option selected>1K</option>
              <option>2K</option>
            </select>
          </div>
          <div>
            <label for="people">personGeneration</label>
            <select id="people" name="people" title="allow people generation">
              <option value="allow_adult" selected>allow_adult (default)</option>
              <option value="dont_allow">dont_allow</option>
              <option value="allow_all">allow_all</option>
            </select>
          </div>
        </div>

        <div class="bar">
          <div class="small">
            Model: <span class="mono">imagen-4.0-generate-001</span><br/>
            Endpoint: <span class="mono">/v1beta/models/...:predict</span>
          </div>
          <div>
            <button id="btn" type="submit">Generate</button>
            <button id="clear" type="button" class="ghost">Clear results</button>
          </div>
        </div>

        <div class="footer">
          Tài liệu API & tham số: Imagen 4 (Gemini API). Tất cả ảnh có SynthID watermark. :contentReference[oaicite:1]{index=1}
        </div>
      </form>

      <div class="card">
        <label>Kết quả</label>
        <div id="out" class="out"></div>
      </div>
    </div>
  </div>

  <script>
    // --- Prefill prompt from your Java sample (giữ nguyên nội dung, xuống dòng rõ ràng)
    const defaultPrompt = `Primary prompt (long, descriptive)

Modern minimalist bedroom, symmetrical frontal view, eye-level. A king bed centered against a warm beige paneled wall. Camel-colored upholstered headboard (soft leather/vinyl), platform base in deep teal/emerald green. White bedding with a lightly rumpled puffy duvet and multiple pillows (two large, two medium, one small accent). Left side: a glossy emerald-green two-drawer nightstand with slim brushed-brass pulls; above it hangs a single pendant light—opal glass globe inside a thin brass ring, suspended by a fine cord. Behind the bed, feature wall with thin black metal reveals forming subtle vertical/horizontal lines and one striking green-blue stone panel (onyx/agate effect) with cloudy veins.

Right side of the composition: a built-in wardrobe with black aluminum frame and smoked-glass sliding doors, showing neatly hung light garments, shelves with folded towels, a cardboard box, and a small suitcase on the lower shelf. Adjacent to it, a plain beige closet door with a tall vertical recessed handle.

Far right background through a black-framed glass partition is a glimpse of the bathroom: terrazzo wall with multicolor chips and a white wall-hung toilet partially visible. Far left: full-height sliding doors to a balcony, black frames, clear glass; outside greenery softly visible. Floor is wide-plank honey-oak wood (matte), with a light gray flat-weave rug under the bed (smaller than the bed, pulled back from the headboard). Window dressing: layered curtains—sheer voile plus heavier beige drapes gathered to the sides.

Daylight scene: soft natural light entering from the left balcony doors, gentle fill, no harsh shadows. Recessed downlights in a white ceiling (subtle, mostly off). Clean, uncluttered, hotel-suite vibe; contemporary lines with a slight mid-century touch (globe pendant). Photorealistic materials, accurate reflections, tidy styling.

Style & material keywords

photorealistic, contemporary minimalism, warm neutral palette, clean lines, hotel suite
materials: camel leather headboard, lacquered MDF nightstand, brushed brass accents, black aluminum frames, smoked glass wardrobe, painted plaster wall (warm beige), green veined onyx/agate accent panel, oak floor, wool flat-weave rug
colors (approx hex): off-white #F5F5F0, warm beige #D9D2C7, camel #C49A7A, emerald/teal base #2F7F71, deep green nightstand #0F6B57, black frame #1E1E1E, honey oak #C9A57A, light gray rug #CFCFCB

Camera & composition

frontal composition, centered symmetry
eye-level height ~1.3–1.4 m
focal length 24–28 mm (full-frame)
white balance 5200–5600 K
soft overcast daylight from the left, subtle GI bounce, low contrast, no crushed blacks`;

    document.getElementById('prompt').value = defaultPrompt;

    const form = document.getElementById('form');
    const out = document.getElementById('out');
    const btn = document.getElementById('btn');
    const clearBtn = document.getElementById('clear');

    clearBtn.addEventListener('click', () => { out.innerHTML = ''; });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const apiKey = document.getElementById('key').value.trim();
      const prompt = document.getElementById('prompt').value.trim();
      const sampleCount = parseInt(document.getElementById('count').value, 10);
      const aspectRatio = document.getElementById('aspect').value;
      const sampleImageSize = document.getElementById('size').value;   // "1K" | "2K"
      const personGeneration = document.getElementById('people').value; // "allow_adult" | "dont_allow" | "allow_all"

      if (!apiKey) { alert('Nhập GEMINI_API_KEY'); return; }
      if (!prompt) { alert('Nhập prompt'); return; }

      btn.disabled = true; btn.textContent = 'Generating...';

      // REST endpoint (Gemini API — Imagen 4). See docs: /v1beta/models/imagen-4.0-generate-001:predict
      const url = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict';

      const body = {
        instances: [{ prompt }],
        parameters: {
          sampleCount,
          aspectRatio,
          sampleImageSize,   // Only for Standard/Ultra models; harmless on base 4.0 generate
          personGeneration
        }
      };

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'x-goog-api-key': apiKey,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const errText = await res.text().catch(()=> '');
          throw new Error(`HTTP ${res.status} – ${res.statusText}\n${errText}`);
        }

        const data = await res.json();

        // According to current docs/observations, REST returns { predictions: [ { bytesBase64Encoded, mimeType }, ... ] }
        // Ref: community report aligning with REST sample. See note in README/issues. 
        const preds = Array.isArray(data.predictions) ? data.predictions : [];

        if (!preds.length) {
          alert('No images returned (predictions empty). Có thể bị chặn bởi safety.');
          return;
        }

        preds.forEach((p, i) => {
          const b64 = p.bytesBase64Encoded || p.imageBytes || '';
          const mime = p.mimeType || 'image/png';
          if (!b64) return;

          const src = `data:${mime};base64,${b64}`;

          const box = document.createElement('div');
          box.className = 'thumb';

          const img = document.createElement('img');
          img.alt = `Generated ${i+1}`;
          img.src = src;

          const actions = document.createElement('div');
          actions.className = 'actions';

          const a = document.createElement('a');
          a.href = src;
          a.download = `image_${i+1}.${mime.includes('jpeg')?'jpeg':mime.includes('jpg')?'jpg':mime.includes('webp')?'webp':'png'}`;
          a.textContent = 'Download';
          a.className = 'ghost';
          a.style.padding = '8px 10px';
          a.style.borderRadius = '8px';
          a.style.textDecoration = 'none';
          a.style.display = 'inline-block';

          const meta = document.createElement('span');
          meta.className = 'small';
          meta.textContent = `${mime} • ${aspectRatio} • ${sampleImageSize}`;

          actions.appendChild(a);

          box.appendChild(img);
          box.appendChild(actions);
          box.appendChild(meta);

          out.prepend(box);
        });

      } catch (err) {
        console.error(err);
        alert('Generate failed:\n' + err.message);
      } finally {
        btn.disabled = false; btn.textContent = 'Generate';
      }
    });
  </script>
</body>
</html>
